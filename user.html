<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>FASTPLAY | Elite</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- FIREBASE (COMPAT MODE) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #f59e0b; --bg-dark: #020617; --card-bg: #0f172a; }
        body { background-color: var(--bg-dark); color: #f8fafc; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        .gaming-font { font-family: 'Teko', sans-serif; letter-spacing: 1px; text-transform: uppercase; }
        .hide { display: none !important; }
        .input-box { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; outline: none; font-size: 14px; }
        
        /* Buttons */
        .btn-main { background: linear-gradient(135deg, #f59e0b, #d97706); color: black; font-weight: 700; padding: 12px; border-radius: 10px; width: 100%; font-family: 'Teko', sans-serif; font-size: 1.2rem; letter-spacing: 0.5px; }
        .btn-copy { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 6px; font-size: 10px; color: #fbbf24; cursor: pointer; }
        
        /* Nav */
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .loader { width: 30px; height: 30px; border: 3px solid #334155; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hide-scroll::-webkit-scrollbar { display: none; }

        /* Tournament Card Style */
        .match-card {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            position: relative;
        }
        .match-card:active { transform: scale(0.98); }
        .card-banner {
            height: 140px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .card-overlay {
            background: linear-gradient(to top, #0f172a, transparent);
            position: absolute; inset: 0;
        }
        .status-badge {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            padding: 4px 10px; border-radius: 6px;
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-live { background: rgba(220, 38, 38, 0.9); color: white; animation: pulse 1.5s infinite; border: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Tabs */
        .home-tab { flex: 1; text-align: center; padding: 10px; font-family: 'Teko', sans-serif; font-size: 1.2rem; color: #64748b; border-bottom: 2px solid #1e293b; cursor: pointer; transition: 0.3s; }
        .home-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] bg-slate-800 border border-amber-500 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 pointer-events-none scale-90 flex items-center gap-2">
        <i class="fa-solid fa-circle-check text-amber-500"></i> <span id="toast-msg">Processing...</span>
    </div>

    <!-- AUTH -->
    <div id="auth-view" class="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-6 bg-[url('https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/90"></div>
        <div class="relative w-full max-w-sm">
            <h1 class="text-7xl font-bold text-center text-amber-500 italic gaming-font mb-8">FASTPLAY</h1>
            
            <div id="login-form" class="bg-slate-900/90 p-8 rounded-2xl border border-slate-700">
                <h2 class="text-2xl text-white mb-6 gaming-font">Login</h2>
                <input type="email" id="l-email" class="input-box mb-4" placeholder="Email">
                <input type="password" id="l-pass" class="input-box mb-6" placeholder="Password">
                <button onclick="loginUser()" class="btn-main">ENTER</button>
                <p class="text-center mt-4 text-xs text-slate-400">No account? <b onclick="toggleAuth('reg')" class="text-amber-500 cursor-pointer">Register</b></p>
            </div>

            <div id="reg-form" class="bg-slate-900/90 p-8 rounded-2xl border border-slate-700 hide">
                <h2 class="text-2xl text-white mb-6 gaming-font">Register</h2>
                <input type="text" id="r-user" class="input-box mb-4" placeholder="Username">
                <input type="email" id="r-email" class="input-box mb-4" placeholder="Email">
                <input type="password" id="r-pass" class="input-box mb-6" placeholder="Password">
                <button onclick="registerUser()" class="btn-main">CREATE</button>
                <p class="text-center mt-4 text-xs text-slate-400">Has account? <b onclick="toggleAuth('login')" class="text-amber-500 cursor-pointer">Login</b></p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-view" class="hide">
        <header class="fixed top-0 w-full z-40 bg-slate-950/95 backdrop-blur border-b border-slate-800 px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="head-pfp" src="" class="w-10 h-10 rounded-full border-2 border-amber-500 object-cover bg-black">
                <div>
                    <h2 id="head-user" class="font-bold text-white leading-none">...</h2>
                    <span class="text-xs text-amber-500 font-bold">&#8377;<span id="head-wallet">0</span></span>
                </div>
            </div>
            <button onclick="nav('wallet')" class="bg-slate-800 text-green-400 px-4 py-2 rounded-lg font-bold text-xs border border-slate-700">ADD +</button>
        </header>

        <main id="main-content" class="pt-20 px-4 min-h-screen"></main>

        <nav class="fixed bottom-0 w-full bg-slate-950/95 backdrop-blur border-t border-slate-800 z-50 pb-safe">
            <div class="grid grid-cols-4 h-16">
                <div onclick="nav('home')" id="nav-home" class="nav-item flex flex-col items-center justify-center cursor-pointer text-slate-500"><i class="fa-solid fa-gamepad text-xl"></i><span class="text-[10px] font-bold mt-1">PLAY</span></div>
                <div onclick="nav('live')" id="nav-live" class="nav-item flex flex-col items-center justify-center cursor-pointer text-slate-500"><i class="fa-brands fa-youtube text-xl"></i><span class="text-[10px] font-bold mt-1">LIVE</span></div>
                <div onclick="nav('wallet')" id="nav-wallet" class="nav-item flex flex-col items-center justify-center cursor-pointer text-slate-500"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold mt-1">WALLET</span></div>
                <div onclick="nav('profile')" id="nav-profile" class="nav-item flex flex-col items-center justify-center cursor-pointer text-slate-500"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold mt-1">ME</span></div>
            </div>
        </nav>
    </div>

    <!-- MODALS (DEPOSIT / WITHDRAW / EDIT) -->
    <div id="modal-deposit" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center hide px-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 relative">
            <button onclick="document.getElementById('modal-deposit').classList.add('hide')" class="absolute top-4 right-4 text-slate-500"><i class="fa-solid fa-xmark fa-xl"></i></button>
            <h3 class="text-2xl text-white text-center mb-6 gaming-font">Add Money</h3>
            <div class="bg-white p-2 rounded-xl w-40 h-40 mx-auto mb-6"><img id="qr-img" src="" class="w-full h-full object-contain"></div>
            <p class="text-center text-xs text-slate-400 mb-4">Pay & Enter UTR</p>
            <input type="number" id="dep-amt" class="input-box mb-3" placeholder="Amount (&#8377;)">
            <input type="text" id="dep-utr" class="input-box mb-4" placeholder="UTR / Transaction ID">
            <button type="button" onclick="submitDeposit()" class="btn-main">SUBMIT REQUEST</button>
        </div>
    </div>

    <div id="modal-withdraw" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center hide px-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 relative">
            <button onclick="document.getElementById('modal-withdraw').classList.add('hide')" class="absolute top-4 right-4 text-slate-500"><i class="fa-solid fa-xmark fa-xl"></i></button>
            <h3 class="text-2xl text-red-500 text-center mb-6 gaming-font">Withdraw</h3>
            <p class="text-center text-xs text-slate-400 mb-4">Winnings: <span id="wd-avail" class="text-white font-bold">&#8377;0</span></p>
            <input type="number" id="wd-amt" class="input-box mb-3" placeholder="Amount (&#8377;)">
            <input type="text" id="wd-upi" class="input-box mb-4" placeholder="UPI ID">
            <button onclick="submitWithdraw()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl">REQUEST</button>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center hide px-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 relative">
            <button onclick="document.getElementById('modal-edit').classList.add('hide')" class="absolute top-4 right-4 text-slate-500"><i class="fa-solid fa-xmark fa-xl"></i></button>
            <h3 class="text-2xl text-white text-center mb-6 gaming-font">Edit Profile</h3>
            <input type="text" id="edit-user" class="input-box mb-3" placeholder="New Username">
            <input type="password" id="edit-pass" class="input-box mb-4" placeholder="New Password (Optional)">
            <button onclick="saveProfile()" class="btn-main">SAVE</button>
        </div>
    </div>

    <!-- SUPPORT CHAT -->
    <div id="support-view" class="fixed inset-0 z-[70] bg-slate-950 flex flex-col hide">
        <div class="bg-slate-900 p-4 border-b border-slate-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button onclick="document.getElementById('support-view').classList.add('hide')" class="text-slate-400"><i class="fa-solid fa-arrow-left fa-lg"></i></button>
                <h3 class="text-lg font-bold text-white">Support</h3>
            </div>
        </div>
        <div id="support-msgs" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#020617]"></div>
        <div class="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
            <input id="support-input" class="input-box" placeholder="Type issue...">
            <button onclick="sendSupport()" class="bg-amber-500 text-black px-4 rounded-xl font-bold"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ⭐ CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyArM0Z3PP5rIXEKls59uLmPDb5eTvVwR-o",
            authDomain: "fastplay-5bba5.firebaseapp.com",
            databaseURL: "https://fastplay-5bba5-default-rtdb.firebaseio.com",
            projectId: "fastplay-5bba5",
            storageBucket: "fastplay-5bba5.firebasestorage.app",
            messagingSenderId: "440804634154",
            appId: "1:440804634154:web:25c0bfd4f6d5596831dd53"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let userData = {};
        let homeTab = 'all'; // 'all' or 'joined'

        // --- UTILS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'scale-90');
            setTimeout(() => t.classList.add('opacity-0', 'scale-90'), 3000);
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showToast("Copied to clipboard!"));
        }

        function toggleAuth(view) {
            document.getElementById('login-form').classList.toggle('hide', view === 'reg');
            document.getElementById('reg-form').classList.toggle('hide', view === 'login');
        }

        // --- AUTH ---
        function loginUser() {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => showToast(err.message));
        }

        function registerUser() {
            const u = document.getElementById('r-user').value;
            const e = document.getElementById('r-email').value;
            const p = document.getElementById('r-pass').value;
            if(!u || p.length < 6) return showToast("Invalid Details");
            
            auth.createUserWithEmailAndPassword(e, p).then(cred => {
                db.ref('users/' + cred.user.uid).set({
                    username: u, email: e, wallet: 0, winnings: 0,
                    profilePic: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                showToast("Account Created!");
            }).catch(err => showToast(err.message));
        }

        function logout() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hide');
                document.getElementById('app-view').classList.remove('hide');
                
                db.ref('users/' + user.uid).on('value', snap => {
                    userData = snap.val() || {};
                    if(userData.winnings === undefined) userData.winnings = 0;
                    document.getElementById('head-user').innerText = userData.username || "Gamer";
                    document.getElementById('head-wallet').innerText = userData.wallet || 0;
                    document.getElementById('head-pfp').src = userData.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                });
                nav('home');
            } else {
                document.getElementById('auth-view').classList.remove('hide');
                document.getElementById('app-view').classList.add('hide');
            }
        });

        function nav(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-'+page).classList.add('active');
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="loader"></div>`;
            window.scrollTo(0,0);

            if(page === 'home') loadHome();
            if(page === 'live') loadLive();
            if(page === 'wallet') loadWallet();
            if(page === 'profile') loadProfile();
        }

        // --- HOME (UPDATED) ---
        function switchHomeTab(tab) {
            homeTab = tab;
            loadHome();
        }

        function loadHome() {
            const main = document.getElementById('main-content');
            
            // Layout Structure with Tabs
            let contentHTML = `
                <div class="flex mb-4">
                    <div onclick="switchHomeTab('all')" class="home-tab ${homeTab==='all'?'active':''}">BROWSE</div>
                    <div onclick="switchHomeTab('joined')" class="home-tab ${homeTab==='joined'?'active':''}">MY MATCHES</div>
                </div>
            `;

            // If Browse Tab -> Show Banners
            if(homeTab === 'all') {
                db.ref('banners').once('value', bSnap => {
                    if(bSnap.exists()) {
                        contentHTML += `<div class="flex gap-4 overflow-x-auto pb-4 hide-scroll mb-4">`;
                        bSnap.forEach(c => {
                            contentHTML += `<img src="${c.val().url}" class="w-80 h-44 rounded-2xl object-cover flex-shrink-0 shadow-lg border border-slate-700">`;
                        });
                        contentHTML += `</div>`;
                    }
                    fetchMatches(contentHTML);
                });
            } else {
                fetchMatches(contentHTML);
            }

            function fetchMatches(baseHTML) {
                db.ref('tournaments').on('value', tSnap => {
                    let mHtml = `<div class="space-y-6 pb-20">`;
                    const matches = [];
                    tSnap.forEach(c => matches.push({key: c.key, ...c.val()}));
                    matches.reverse();

                    let countMatches = 0;

                    matches.forEach(m => {
                        const isJoined = m.participants && m.participants[currentUser.uid];
                        
                        // Tab Filter Logic
                        if(homeTab === 'joined' && !isJoined) return;

                        countMatches++;
                        const count = m.participants ? Object.keys(m.participants).length : 0;
                        const percent = Math.min((count/m.totalSlots)*100, 100);
                        const statusClass = (m.status || '').toLowerCase() === 'live' ? 'status-live' : 'bg-slate-900/80 text-slate-300';

                        mHtml += `
                        <div onclick="openMatch('${m.key}')" class="match-card cursor-pointer">
                            <div class="card-banner" style="background-image: url('${m.banner}')">
                                <div class="card-overlay"></div>
                                <div class="status-badge ${statusClass}">${m.status}</div>
                                <div class="absolute bottom-3 left-4 right-4">
                                    <h4 class="text-white font-bold text-xl gaming-font tracking-wide shadow-black drop-shadow-md truncate">${m.title}</h4>
                                    <div class="flex justify-between items-end mt-1">
                                        <div class="text-slate-300 text-xs font-bold shadow-black drop-shadow-md">
                                            <i class="fa-solid fa-gamepad text-amber-500 mr-1"></i> ${m.game} • ${m.mode}
                                        </div>
                                        <div class="text-amber-400 font-bold text-sm bg-black/50 px-2 py-1 rounded border border-amber-500/30">
                                            PRIZE: &#8377;${m.entryFee * m.totalSlots}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden mb-2 border border-slate-700">
                                    <div class="bg-gradient-to-r from-amber-500 to-orange-600 h-full" style="width: ${percent}%"></div>
                                </div>
                                <div class="flex justify-between items-center text-xs font-bold">
                                    <span class="text-slate-400">${count}/${m.totalSlots} Players</span>
                                    ${isJoined 
                                        ? '<span class="text-green-400"><i class="fa-solid fa-circle-check"></i> JOINED</span>' 
                                        : `<span class="bg-slate-800 text-white px-3 py-1.5 rounded border border-slate-700">JOIN &#8377;${m.entryFee}</span>`}
                                </div>
                            </div>
                        </div>`;
                    });

                    if(countMatches === 0) {
                        mHtml += `<div class="text-center py-10 text-slate-500 text-sm">No matches found in this section.</div>`;
                    }
                    mHtml += `</div>`;
                    main.innerHTML = baseHTML + mHtml;
                });
            }
        }

        function openMatch(id) {
            window.scrollTo(0,0);
            db.ref('tournaments/'+id).on('value', snap => {
                const m = snap.val();
                if(!m) return nav('home');
                const isJoined = m.participants && m.participants[currentUser.uid];
                const status = (m.status || "").toLowerCase();
                const isLive = status === 'live';

                // --- UPGRADED ROOM UI WITH COPY BUTTONS ---
                let roomUI = '';
                if(isJoined && isLive) {
                    roomUI = `
                    <div class="bg-slate-900 border border-green-500/50 p-5 rounded-2xl mb-6 text-center animate-pop relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
                        <p class="text-green-400 text-xs font-bold mb-3 tracking-[0.2em] uppercase">● Room Access Granted</p>
                        <div class="grid grid-cols-2 gap-4 text-white font-mono text-sm">
                            <div class="bg-black/40 p-3 rounded-lg border border-slate-800">
                                <span class="text-slate-500 text-[10px] block font-sans uppercase mb-1">Room ID</span>
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-lg font-bold">${m.roomID || '...'}</span>
                                    <button onclick="copyText('${m.roomID}')" class="btn-copy"><i class="fa-regular fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="bg-black/40 p-3 rounded-lg border border-slate-800">
                                <span class="text-slate-500 text-[10px] block font-sans uppercase mb-1">Password</span>
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-lg font-bold">${m.roomPass || '...'}</span>
                                    <button onclick="copyText('${m.roomPass}')" class="btn-copy"><i class="fa-regular fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else if(isJoined && status !== 'completed') {
                    roomUI = `<div class="bg-slate-900 border border-slate-800 p-4 rounded-xl mb-6 text-center text-xs text-slate-500">
                        <i class="fa-solid fa-clock mr-1"></i> Room ID & Password will appear here when match is <b>LIVE</b>.
                    </div>`;
                }

                let btn = isJoined ? 
                    `<button class="w-full bg-slate-800 text-slate-400 font-bold py-3 rounded-xl mb-4 cursor-not-allowed border border-slate-700">ALREADY JOINED</button>` : 
                    `<button onclick="joinMatch('${id}', ${m.entryFee})" class="btn-main mb-4">JOIN MATCH • &#8377;${m.entryFee}</button>`;
                
                if(status === 'completed') {
                    btn = `<button class="w-full bg-slate-800 text-slate-500 font-bold py-3 rounded-xl mb-4 cursor-not-allowed border border-slate-700">MATCH ENDED</button>`;
                }

                document.getElementById('main-content').innerHTML = `
                    <div class="relative w-full h-64 -mx-4 w-[calc(100%+2rem)] -mt-6 mb-6">
                        <img src="${m.banner}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 to-transparent"></div>
                        <button onclick="nav('home')" class="absolute top-4 left-4 w-10 h-10 bg-black/40 rounded-full text-white flex items-center justify-center backdrop-blur"><i class="fa-solid fa-arrow-left"></i></button>
                    </div>
                    <div class="mb-6">
                        <h1 class="text-4xl text-white font-bold mb-2 gaming-font leading-none">${m.title}</h1>
                        <div class="flex gap-2 text-xs text-slate-400 font-bold">
                            <span class="bg-slate-900 px-2 py-1 rounded border border-slate-800">${m.game}</span>
                            <span class="bg-slate-900 px-2 py-1 rounded border border-slate-800">${m.mode}</span>
                            <span class="bg-slate-900 px-2 py-1 rounded border border-slate-800">${new Date(m.date).toLocaleString()}</span>
                        </div>
                    </div>
                    ${roomUI}
                    ${btn}
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl mb-4">
                        <h3 class="text-amber-500 font-bold text-xs uppercase mb-3 tracking-widest border-b border-slate-800 pb-2">Prize Pool</h3>
                        <pre class="text-slate-300 text-sm font-sans whitespace-pre-wrap leading-relaxed">${m.prizeTable}</pre>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl mb-20">
                        <h3 class="text-blue-500 font-bold text-xs uppercase mb-3 tracking-widest border-b border-slate-800 pb-2">Rules</h3>
                        <p class="text-slate-300 text-sm whitespace-pre-wrap leading-relaxed">${m.rules}</p>
                    </div>
                `;
            });
        }

        window.joinMatch = function(id, fee) {
            if(userData.wallet < fee) { showToast("Insufficient Funds"); nav('wallet'); return; }
            const uid = prompt("Enter Game UID / Character ID:"); 
            if(!uid) return;
            
            db.ref('users/'+currentUser.uid).update({ wallet: userData.wallet - fee });
            db.ref('tournaments/'+id+'/participants/'+currentUser.uid).set({
                username: userData.username, gameName: uid, joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
            showToast("Joined Successfully!");
        };

        // --- LIVE FIX ---
        function loadLive() {
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="loader"></div>`;
            
            db.ref('live').on('value', snap => {
                const d = snap.val() || {};
                const vidId = d.youtubeId || "";
                
                main.innerHTML = `
                    <div class="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-lg mb-4 border border-slate-800">
                        ${vidId ? `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${vidId}?autoplay=1&mute=1&playsinline=1" frameborder="0" allowfullscreen></iframe>` : '<div class="h-full flex items-center justify-center text-slate-500">Stream Offline</div>'}
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl h-[50vh] flex flex-col">
                        <div class="p-3 border-b border-slate-800 font-bold text-amber-500 text-xs">LIVE CHAT</div>
                        <div id="live-chat" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                        <div class="p-2 border-t border-slate-800 flex gap-2">
                            <input id="chat-input" class="input-box" placeholder="Message..." onkeydown="if(event.key==='Enter') sendChat()">
                            <button onclick="sendChat()" class="bg-amber-500 text-black px-4 rounded font-bold"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>`;
                
                db.ref('live/chat').limitToLast(50).on('value', cSnap => {
                    const box = document.getElementById('live-chat');
                    if(!box) return;
                    box.innerHTML = '';
                    cSnap.forEach(c => {
                        const m = c.val();
                        box.innerHTML += `<div class="text-xs break-words"><span class="text-slate-400 font-bold">${m.user}:</span> <span class="text-white">${m.text}</span></div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
            });
        }

        window.sendChat = function() {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                db.ref('live/chat').push({
                    user: userData.username, text: input.value, ts: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            }
        };

        // --- WALLET & DEPOSIT ---
        function loadWallet() {
            const depBal = Math.max(0, (userData.wallet || 0) - (userData.winnings || 0));
            const winBal = userData.winnings || 0;

            document.getElementById('main-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800 border border-slate-700 p-4 rounded-xl">
                        <p class="text-slate-400 text-[10px] uppercase font-bold">Deposit</p>
                        <h2 class="text-2xl text-white font-bold">&#8377;${depBal}</h2>
                    </div>
                    <div class="bg-slate-800 border border-amber-500/30 p-4 rounded-xl">
                        <p class="text-amber-500 text-[10px] uppercase font-bold">Winnings</p>
                        <h2 class="text-2xl text-white font-bold">&#8377;${winBal}</h2>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button onclick="openDeposit()" class="bg-slate-800 border border-slate-700 py-3 rounded-xl text-green-400 font-bold">Deposit</button>
                    <button onclick="openWithdraw()" class="bg-slate-800 border border-slate-700 py-3 rounded-xl text-red-400 font-bold">Withdraw</button>
                </div>
                <h3 class="text-slate-500 font-bold text-xs mb-4">TRANSACTIONS</h3>
                <div id="tx-list" class="space-y-3 pb-20"><div class="loader"></div></div>
            `;

            db.ref('payments').on('value', snap => {
                const list = document.getElementById('tx-list');
                if(!list) return;
                list.innerHTML = '';
                const txs = [];
                const d = snap.val() || {};
                
                if(d.deposits) Object.values(d.deposits).forEach(x => { if(x.uid===currentUser.uid) txs.push({...x, t:'dep'}); });
                if(d.withdrawals) Object.values(d.withdrawals).forEach(x => { if(x.uid===currentUser.uid) txs.push({...x, t:'wd'}); });
                
                if(txs.length === 0) { list.innerHTML = '<div class="text-center text-slate-600 text-xs py-4">No transactions found.</div>'; return; }
                
                txs.sort((a,b) => b.date - a.date);
                txs.forEach(t => {
                    const isDep = t.t === 'dep';
                    const color = isDep ? 'text-green-400' : 'text-red-400';
                    const sign = isDep ? '+' : '-';
                    list.innerHTML += `
                    <div class="bg-slate-800 border border-slate-700 p-3 rounded-xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center ${color}"><i class="fa-solid ${isDep?'fa-arrow-down':'fa-arrow-up'}"></i></div>
                            <div><div class="font-bold text-sm text-white">${isDep?'Deposit':'Withdraw'}</div><div class="text-[10px] text-slate-500">${isDep?t.utr:t.upi}</div></div>
                        </div>
                        <div class="text-right"><div class="font-bold ${color}">${sign}&#8377;${t.amount}</div><div class="text-[10px] text-slate-400 uppercase">${t.status}</div></div>
                    </div>`;
                });
            });
        }

        window.openDeposit = function() {
            document.getElementById('modal-deposit').classList.remove('hide');
            db.ref('admin/qrCode').once('value', s => {
                document.getElementById('qr-img').src = s.val() || 'https://via.placeholder.com/200';
            });
        };

        window.submitDeposit = function() {
            const amt = document.getElementById('dep-amt').value;
            const utr = document.getElementById('dep-utr').value;
            if(!amt || !utr) return showToast("Enter Details");
            
            db.ref('payments/deposits').push({
                uid: currentUser.uid, username: userData.username, amount: parseInt(amt), utr: utr, status: 'pending', date: firebase.database.ServerValue.TIMESTAMP
            });
            showToast("Deposit Sent!");
            document.getElementById('modal-deposit').classList.add('hide');
        };

        window.openWithdraw = function() {
            document.getElementById('wd-avail').innerText = `&#8377;${userData.winnings || 0}`;
            document.getElementById('modal-withdraw').classList.remove('hide');
        };

        window.submitWithdraw = function() {
            const amt = parseInt(document.getElementById('wd-amt').value);
            const upi = document.getElementById('wd-upi').value;
            if(!amt || !upi) return showToast("Enter Details");
            if((userData.winnings || 0) < amt) return showToast("Low Winnings!");

            const newWin = userData.winnings - amt;
            const newTotal = userData.wallet - amt;
            
            db.ref('users/'+currentUser.uid).update({ wallet: newTotal, winnings: newWin });
            db.ref('payments/withdrawals').push({
                uid: currentUser.uid, amount: amt, upi: upi, status: 'pending', date: firebase.database.ServerValue.TIMESTAMP
            });
            showToast("Withdraw Sent!");
            document.getElementById('modal-withdraw').classList.add('hide');
        };

        // --- PROFILE ---
        function loadProfile() {
             const pfp = userData.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
             document.getElementById('main-content').innerHTML = `
                <div class="flex flex-col items-center mt-8 mb-8">
                    <div class="relative w-28 h-28 mb-4">
                        <img src="${pfp}" class="w-full h-full rounded-full border-4 border-slate-800 object-cover">
                        <label class="absolute bottom-0 right-0 bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-white cursor-pointer"><i class="fa-solid fa-camera text-xs"></i><input type="file" class="hidden" onchange="upPfp(this)"></label>
                    </div>
                    <h2 class="text-3xl font-bold gaming-font text-white">${userData.username}</h2>
                    <p class="text-slate-500 text-sm">${currentUser.email}</p>
                    <button onclick="document.getElementById('modal-edit').classList.remove('hide')" class="mt-4 text-xs bg-slate-800 px-4 py-2 rounded-full border border-slate-700">Edit</button>
                </div>
                <div class="space-y-4">
                     <div onclick="openSupport()" class="bg-slate-800 border border-slate-700 p-4 rounded-xl flex justify-between items-center cursor-pointer">
                        <div class="flex items-center gap-3"><i class="fa-solid fa-headset text-blue-500"></i><span class="font-bold text-slate-300">Support Chat</span></div><i class="fa-solid fa-chevron-right text-slate-600"></i>
                     </div>
                     <button onclick="logout()" class="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl flex justify-between items-center text-red-500"><div class="flex items-center gap-3"><i class="fa-solid fa-right-from-bracket"></i><span class="font-bold">Logout</span></div></button>
                </div>
             `;
        }

        window.openSupport = function() {
            document.getElementById('support-view').classList.remove('hide');
            db.ref('support/' + currentUser.uid).on('value', snap => {
                const box = document.getElementById('support-msgs');
                box.innerHTML = '';
                snap.forEach(c => {
                    const m = c.val();
                    const align = m.sender === 'user' ? 'text-right' : 'text-left';
                    const bg = m.sender === 'user' ? 'bg-amber-500 text-black' : 'bg-slate-800 text-white';
                    box.innerHTML += `<div class="${align}"><span class="${bg} px-3 py-1 rounded inline-block text-sm">${m.text}</span></div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendSupport = function() {
            const i = document.getElementById('support-input');
            if(i.value) { db.ref('support/' + currentUser.uid).push({ sender: 'user', text: i.value, ts: firebase.database.ServerValue.TIMESTAMP }); i.value = ''; }
        };

        window.saveProfile = async function() {
            const u = document.getElementById('edit-user').value;
            const p = document.getElementById('edit-pass').value;
            if(u) await db.ref('users/'+currentUser.uid).update({username: u});
            if(p && p.length >= 6) {
                try { await currentUser.updatePassword(p); showToast("Password Updated!"); }
                catch(e) { showToast("Re-login required!"); }
            }
            showToast("Saved!"); document.getElementById('modal-edit').classList.add('hide');
        };

        window.upPfp = function(input) {
            if(input.files[0]) {
                const reader = new FileReader();
                reader.readAsDataURL(input.files[0]);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 300 / img.width;
                        canvas.width = 300; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        db.ref('users/'+currentUser.uid).update({ profilePic: canvas.toDataURL('image/jpeg', 0.7) });
                        showToast("Updated!");
                    }
                }
            }
        };
    </script>
</body>
</html>